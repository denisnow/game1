<!doctype html>

<html lang="en">

	<head>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>15-Game</title>

		<style>
			body {
				background-image: url('./img/bg.svg');
				background-color: #87ceeb;
				background-size: 250px 250px;
				margin: 0;
			}

			.board {
				position: absolute;
				width: 99vw;
				height: 99vw;
				top: 50%;
				margin: -50vw 0 0 1vw;
			}

			.block {
				position: absolute;
			}

			.blockNumber {
				display: table-cell;
				position: relative;
				text-align: center;
				vertical-align: middle;
				height: 23.75vw;
				width: 23.75vw;
				user-select: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
			}

			.text {
				background-color: white;
				opacity: 0.77;
				font-family: Helvetica, Arial, sans-serif;
				font-size: 11vw;
				color: #298f91;
			}

			.clickable {
				cursor: pointer;
			}

			noscript > p {
				display: inline-block;
				margin: 10px;
			}

			.infoBtn:hover {
				opacity: 1;
			}

			.infoBtn {
				cursor: pointer;
				position: relative;
				border: 0;
				padding: 0;
				float: right;
				opacity: 0.8;
				top: -19vw;
				right: 4vw;
				width: 15vw;
				height: 15vw;
				font-family: "Times New Roman", Times, serif;
				font-size: 11vw;
				color: #298f91;
				background: url('./img/infobtn.svg') no-repeat;
			}

			.visuallyHidden:not(:focus):not(:active) {
				position: absolute !important;
				clip: rect(1px 1px 1px 1px);
				clip: rect(1px, 1px, 1px, 1px);
				padding:0 !important;
				border:0 !important;
				height: 1px !important; 
				width: 1px !important; 
				overflow: hidden;
				white-space: nowrap !important;
			}

			.hidden {
				display: none;
			}

			@media (orientation: landscape) {

				.board {
					width: 80vh;
					height: 80vh;
					left: 50%;
					margin: -39.5vh 0 0 -40vh;
				}

				.blockNumber {
					height: 19vh;
					width: 19vh;
				}

				.text {
					font-size: 10vh;
				}

				.infoBtn {
					right: -25vh;
					top: 0;
					width: 16vh;
					height: 16vh;
					font-size: 10vh;
				}
			}

			@media (min-width: 541px) and (min-height: 541px) {

				body {
					background-size: 350px 350px;
				}

				.board {
					width: 400px;
					height: 400px;
					left: 50%;
					margin: -200px 0 0 -200px;
				}

				.blockNumber {
					height: 96px;
					width: 96px;
				}

				.text {
					font-size: 33px;
				}

				.infoBtn {
					right: -76px;
					top: -80px;
					width: 70px;
					height: 70px;
					font-size: 34px;
				}
			}
		</style>

	</head>

	<body>

		<noscript class="text">
			<p>This page requires JavaScript.</p>
			<p>Your browser doesn't support JavaScript or JavaScript is disabled.</p>
			<p>Here are the <a href="https://www.enable-javascript.com/">instructions how to enable JavaScript in your browser</a>.</p>
		</noscript>

		<h1 class="visuallyHidden">15-game</h1>

		<div class="board">
			<button class="infoBtn hidden">i</button>
		</div>

		<div class="infoModal hidden">modal</div>

		<script>

			var board,	// board element
				matrix,	// 2D array containing block elements
				voidC,	// void coordinates
				infoBtn, infoModal; // information button and information modal elements

			function renderBoard() {

				function makeMatrixAndRenderBlocks() {

					var arr, block, blockNumber,
						arrIndex = 0;

					function makeArray() {

						var isSolvable;

						function shuffleArray() {

							var randomIndex, temp;

							arr.map(function(value, index) {
								randomIndex = Math.floor(Math.random()*16);
								if (arr[randomIndex] !== value) {
									temp = arr[randomIndex];
									arr[randomIndex] = value;
									arr[index] = temp;
								}
							});
						}

						function checkIsSolvable() {

							var nullIndex,
								inversionCount = 0;

							arr.map(function(value, index) {
								if (value === 0) nullIndex = index;
								if (value > 1) for (i = index+1; i < 16; i++) {
									if (value > arr[i] && arr[i] !== 0) inversionCount++;
								}

							});
							if (
								(!(inversionCount%2) && ((nullIndex > 3 && nullIndex < 8) || (nullIndex > 11 && nullIndex < 16)))
								||
								((inversionCount%2) && (nullIndex < 4 || (nullIndex > 7 && nullIndex < 12)))
							) isSolvable = true;
						}

						arr = [];
						for (var i = 0; i < 16; i++) arr.push(i);
						while (!isSolvable) {
							shuffleArray();
							checkIsSolvable();
						}
					}

					makeArray();
					matrix = [];
					for (var i = 0; i < 4; i++) {
						matrix[i] = [];
						for (var j = 0; j < 4; j++) {
							if (arr[arrIndex]) {
								block = document.createElement("div");
								block.className = "block";
								block.setAttribute("style", "left: " + 25*j + "%; top: " + 25*i + "%;");
								block.m=i;
								block.n=j;
								blockNumber = document.createElement("div");
								blockNumber.className = "blockNumber text";
								blockNumber.textContent = arr[arrIndex];
								block.appendChild(blockNumber);
								board.appendChild(block);
								matrix[i][j] = block;
							}
							else voidC = {m: i, n: j};
							arrIndex++;
						}
					}
				}

				board = document.body.querySelector(".board");
				makeMatrixAndRenderBlocks();
			}

			function displayButton() {

				infoBtn = document.body.querySelector(".infoBtn");
				infoBtn.className = "infoBtn";
			}

			function makeButtonResponsive() {

				infoModal = document.body.querySelector(".infoModal");
				infoBtn.addEventListener("click", function() {
					infoModal.className = "infoModal";
				});
			}

			function makeBoardResponsive() {

				board.processMovableBlocks = function(classString) {

					for (var i = 0; i < 4; i++) {
						if (i !== voidC.n) board.setClassName(matrix[voidC.m][i], classString);
						if (i !== voidC.m) board.setClassName(matrix[i][voidC.n], classString);
					}
				};

				board.clickHandler = function(e) {

					if (e.target.parentNode.m === voidC.m || e.target.parentNode.n === voidC.n) {
						board.makeBlocksStatic();
						board.targetElement = e.target.parentNode;
						board.moveBlocks();
					}
				};

				board.setClassName = function(element, classString) {

					element.className = classString;
				};

				board.makeBlocksResponsive = function() {

					board.processMovableBlocks("block clickable");
					board.addEventListener("click", board.clickHandler);
				};

				board.makeBlocksStatic = function() {

					board.processMovableBlocks("block");
					board.removeEventListener("click", board.clickHandler);
				};

				board.moveBlocksUp = function() {

					for (var i = voidC.m+1; i <= board.targetElement.m; i++) {
						matrix[i][voidC.n].setAttribute("style", "left: " + 25*voidC.n + "%; top: " + (25*i-board.percentCount) + "%;");
						if (board.percentCount === 25) {
							matrix[i][voidC.n].m--;
							matrix[i-1][voidC.n] = matrix[i][voidC.n];
						}
					}
					if (board.percentCount === 25) voidC.m += board.amountOfBlocks;
				};

				board.moveBlocksDown = function() {

					for (var i = voidC.m-1; i >= board.targetElement.m; i--) {
						matrix[i][voidC.n].setAttribute("style", "left: " + 25*voidC.n + "%; top: " + (25*i+board.percentCount) + "%;");
						if (board.percentCount === 25) {
							matrix[i][voidC.n].m++;
							matrix[i+1][voidC.n] = matrix[i][voidC.n];
						}
					}
					if (board.percentCount === 25) voidC.m -= board.amountOfBlocks;
				};

				/*
				board.verticalMove = function() {

					board.vd = (voidC.m-board.targetElement.m)/board.amountOfBlocks; //vector direction

					for (var i = voidC.m-board.vd; i*board.vd >= board.targetElement.m*board.vd; i -= board.vd) {
						matrix[i][voidC.n].setAttribute("style", "left: " + 100*voidC.n + "px; top: " + (100*i+board.percentCount*board.vd) + "px;");
						if (board.percentCount === 100) {
							matrix[i][voidC.n].m += board.vd;
							matrix[i+board.vd][voidC.n] = matrix[i][voidC.n];
						}
					}
					if (board.percentCount === 100) voidC.m -= board.amountOfBlocks*board.vd;
				};
				*/				
				
				board.moveBlocksToTheRight = function() {

					for (var i = voidC.n-1; i >= board.targetElement.n; i--) {
						matrix[voidC.m][i].setAttribute("style", "left: " + (25*i+board.percentCount) + "%; top: " + 25*voidC.m + "%;");
						if (board.percentCount === 25) {
							matrix[voidC.m][i].n++;
							matrix[voidC.m][i+1] = matrix[voidC.m][i];
						}
					}
					if (board.percentCount === 25) voidC.n -= board.amountOfBlocks;
				};

				board.moveBlocksToTheLeft = function() {

					for (var i = voidC.n+1; i <= board.targetElement.n; i++) {
						matrix[voidC.m][i].setAttribute("style", "left: " + (25*i-board.percentCount) + "%; top: " + 25*voidC.m + "%;");
						if (board.percentCount === 25) {
							matrix[voidC.m][i].n--;
							matrix[voidC.m][i-1] = matrix[voidC.m][i];
						}
					}
					if (board.percentCount === 25) voidC.n += board.amountOfBlocks;
				};

				/*
				board.horizontalMove = function() {

					board.vd = (voidC.n-board.targetElement.n)/board.amountOfBlocks; //vector direction

					for (var i = voidC.n-board.vd; i*board.vd >= board.targetElement.n*board.vd; i -= board.vd) {
						matrix[voidC.m][i].setAttribute("style", "left: " + (100*i+board.percentCount*board.vd) + "px; top: " + 100*voidC.m + "px;");
						if (board.percentCount === 100) {
							matrix[voidC.m][i].n += board.vd;
							matrix[voidC.m][i+board.vd] = matrix[voidC.m][i];
						}
					}
					if (board.percentCount === 100) voidC.n -= board.amountOfBlocks*board.vd;
				};
				*/

				board.setBlocksMovingDirection = function() {

					if (board.targetElement.m !== voidC.m) {
						if (board.targetElement.m > voidC.m) board.moveBlocksPartially = board.moveBlocksUp;
						else board.moveBlocksPartially = board.moveBlocksDown;
					}
					else {
						if (board.targetElement.n < voidC.n) board.moveBlocksPartially = board.moveBlocksToTheRight;
						else board.moveBlocksPartially = board.moveBlocksToTheLeft;
					}
				};

				/*
				board.checkMovingAxis = function() {

					if (board.targetElement.m !== voidC.m) board.moveBlocksPartially = board.verticalMove;
					else board.moveBlocksPartially = board.horizontalMove;
				};
				*/

				board.checkIsSorted = function() {

					board.temp = 0;
					for (var i = 3; i >= 0; i--) {
						for (var j = 3; j >= 0; j--) {
							if (matrix[i][j]) {
								if (board.temp) {
									if (i === 1 && j === 1) {
										board.isSorted = true;
										return;
									}
									if (Number(matrix[i][j].firstChild.textContent) !== board.temp-1) return;
								}
								board.temp = matrix[i][j].firstChild.textContent;
							}
						}
					}
				};

				board.moveBlocks = function() {

					board.percentCount = 1;
					board.amountOfBlocks = Math.abs(board.targetElement.m-voidC.m || board.targetElement.n-voidC.n);
					board.setBlocksMovingDirection();
					board.intervalID = setInterval(function() {
						board.percentCount += 2;
						board.moveBlocksPartially();
						if (board.percentCount === 25) {
							clearInterval(board.intervalID);
							matrix[voidC.m][voidC.n] = 0;
							if (voidC.m === 3 && voidC.n === 3) board.checkIsSorted();
							if (!board.isSorted) board.makeBlocksResponsive();
						}
					}, 3);
				};

				board.makeBlocksResponsive();
			}

			renderBoard();
			displayButton();
			makeButtonResponsive();
			makeBoardResponsive();

		</script>

	</body>

</html>